import{v as y,r as t,c as k,U as P,d as D,S as N,f as S,h as A,t as T,e as h,L as w}from"./index-Dh3SBaGN.js";(function(){try{var b=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},i=new Error().stack;i&&(b._sentryDebugIds=b._sentryDebugIds||{},b._sentryDebugIds[i]="9d8de166-b209-4e80-b7c3-7a038003a6e4",b._sentryDebugIdIdentifier="sentry-dbid-9d8de166-b209-4e80-b7c3-7a038003a6e4")}catch{}})();const x={Tn:function(b){const i=(b+"=".repeat((4-b.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),e=atob(i),s=new Uint8Array(e.length);for(let r=0;r<e.length;++r)s[r]=e.charCodeAt(r);return s}};class v{constructor(i,e,s,r,o,u,n,c,p,a){this.sn=i,this.rn=e,this.on=s,this.un=o,this.an=u,this.yt=n,this.cn=c,this.hn=p,this.u=a,this.sn=i,this.rn=e,this.on=s,this.fn=r+"/safari/"+e,this.un=o||"/service-worker.js",this.an=u,this.yt=n,this.cn=c||!1,this.hn=p||!1,this.u=a,this.ln=y.dn(),this.pn=y.bn()}mn(){return this.hn}yn(i,e,s,r,o){i.unsubscribe().then(u=>{u?this.vn(e,s,r,o):(t.error("Failed to unsubscribe device from push."),typeof o=="function"&&o(!1))}).catch(u=>{t.error("Push unsubscription error: "+u),typeof o=="function"&&o(!1)})}gn(i,e,s){var r;const o=(a=>{if(typeof a=="string")return a;if(a.endpoint.indexOf("https://android.googleapis.com/gcm/send")!==0)return a.endpoint;let f=a.endpoint;const d=a;return d.wn&&a.endpoint.indexOf(d.wn)===-1&&(f=a.endpoint+"/"+d.wn),f})(i);let u=null,n=null;const c=i;if(c.getKey!=null)try{const a=Array.from(new Uint8Array(c.getKey("p256dh"))),f=Array.from(new Uint8Array(c.getKey("auth")));u=btoa(String.fromCharCode.apply(null,a)),n=btoa(String.fromCharCode.apply(null,f))}catch(a){t.error(k(a))}const p=(a=>{let f;return a.options&&(f=a.options.applicationServerKey)&&f.byteLength&&f.byteLength>0?btoa(String.fromCharCode.apply(null,Array.from(new Uint8Array(f)))).replace(/\+/g,"-").replace(/\//g,"_"):null})(c);(r=this.sn)===null||r===void 0||r.kn(o,e,u,n,p),o&&typeof s=="function"&&s(o,u,n)}Pn(){var i;(i=this.sn)===null||i===void 0||i.Dn(!0)}Sn(i,e){var s;(s=this.sn)===null||s===void 0||s.Dn(!1),t.info(i),typeof e=="function"&&e(!1)}An(i,e,s,r){var o;if(e.permission==="default")try{window.safari.pushNotification.requestPermission(this.fn,i,{api_key:this.rn,device_id:((o=this.on)===null||o===void 0?void 0:o.ce().id)||""},u=>{u.permission==="granted"&&this.sn&&this.sn.setPushNotificationSubscriptionType(P.NotificationSubscriptionTypes.OPTED_IN),this.An(i,u,s,r)})}catch(u){this.Sn("Could not request permission for push: "+u,r)}else e.permission==="denied"?this.Sn("The user has blocked notifications from this site, or Safari push is not configured in the Braze dashboard.",r):e.permission==="granted"&&(t.info("Device successfully subscribed to push."),this.gn(e.deviceToken,new Date,s))}requestPermission(i,e,s){const r=u=>{switch(u){case"granted":return void(typeof i=="function"&&i());case"default":return void(typeof e=="function"&&e());case"denied":return void(typeof s=="function"&&s());default:t.error("Received unexpected permission result "+u)}};let o=!1;if(window.Notification.permission!=="default")r(Notification.permission);else{const u=window.Notification.requestPermission(n=>{o&&r(n)});u?u.then(n=>{r(n)}):o=!0}}vn(i,e,s,r){const o={userVisibleOnly:!0};e!=null&&(o.applicationServerKey=e),i.pushManager.subscribe(o).then(u=>{t.info("Device successfully subscribed to push."),this.gn(u,new Date,s)}).catch(u=>{y.isPushBlocked()?(t.info("Permission for push notifications was denied."),typeof r=="function"&&r(!1)):(t.error("Push subscription failed: "+u),typeof r=="function"&&r(!0))})}jn(){return this.cn?navigator.serviceWorker.getRegistration(this.un):navigator.serviceWorker.register(this.un).then(()=>navigator.serviceWorker.ready.then(i=>(i&&typeof i.update=="function"&&i.update().catch(e=>{t.info("ServiceWorker update failed: "+e)}),i)))}xn(i){this.cn||(i.unregister(),t.info("Service worker successfully unregistered."))}subscribe(i,e){if(!y.isPushSupported())return t.info(v.Nn),void(typeof e=="function"&&e(!1));if(this.ln){if(!this.cn&&window.location!=null){let n=this.un;n.indexOf(window.location.host)===-1&&(n=window.location.host+n),n.indexOf(window.location.protocol)===-1&&(n=window.location.protocol+"//"+n);const c=n.substr(0,n.lastIndexOf("/")+1);if(D.Un().indexOf(c)!==0)return t.error("Cannot subscribe to push from a path higher than the service worker location (tried to subscribe from "+window.location.pathname+" but service worker is at "+n+")"),void(typeof e=="function"&&e(!0))}if(y.isPushBlocked())return void this.Sn("Notifications from this site are blocked. This may be a temporary embargo or a permanent denial.",e);if(this.yt&&!this.yt.Wn()&&this.yt.ii()===0)return t.info("Waiting for VAPID key from server config before subscribing to push."),void this.yt._n(()=>{this.subscribe(i,e)});const s=()=>{t.info("Permission for push notifications was denied."),typeof e=="function"&&e(!1)},r=()=>{let n="Permission for push notifications was ignored.";y.isPushBlocked()&&(n+=" The browser has automatically blocked further permission requests for a period (probably 1 week)."),t.info(n),typeof e=="function"&&e(!0)},o=y.isPushPermissionGranted(),u=()=>{!o&&this.sn&&this.sn.setPushNotificationSubscriptionType(P.NotificationSubscriptionTypes.OPTED_IN),this.jn().then(n=>{if(n==null)return t.error("No service worker registration. Set the `manageServiceWorkerExternally` initialization option to false or ensure that your service worker is registered before calling registerPush."),void(typeof e=="function"&&e(!0));n.pushManager.getSubscription().then(c=>{var p;let a=null;if(((p=this.yt)===null||p===void 0?void 0:p.Wn())!=null&&(a=x.Tn(this.yt.Wn())),c){let f,d=null,m=null;if(this.u&&(f=this.u.j(N.C.In)),f&&!S(f)){let g;try{g=T.qn(f).Vn}catch{g=null}g==null||isNaN(g.getTime())||g.getTime()===0||(d=g,m=new Date(d),m.setMonth(d.getMonth()+6))}a!=null&&c.options&&c.options.applicationServerKey&&c.options.applicationServerKey.byteLength&&c.options.applicationServerKey.byteLength>0&&!A(a,new Uint8Array(c.options.applicationServerKey))?(c.options.applicationServerKey.byteLength>12?t.info("Device was already subscribed to push using a different VAPID provider, creating new subscription."):t.info("Attempting to upgrade a gcm_sender_id-based push registration to VAPID - depending on the browser this may or may not result in the same gcm_sender_id-based subscription."),this.yn(c,n,a,i,e)):c.expirationTime&&new Date(c.expirationTime).valueOf()<=new Date().valueOf()?(t.info("Push subscription is expired, creating new subscription."),this.yn(c,n,a,i,e)):f&&S(f)?this.yn(c,n,a,i,e):m==null?(t.info("No push subscription creation date found, creating new subscription."),this.yn(c,n,a,i,e)):m.valueOf()<=new Date().valueOf()?(t.info("Push subscription older than 6 months, creating new subscription."),this.yn(c,n,a,i,e)):(t.info("Device already subscribed to push, sending existing subscription to backend."),this.gn(c,d,i))}else this.vn(n,a,i,e)}).catch(c=>{t.error("Error checking current push subscriptions: "+c)})}).catch(n=>{t.error("ServiceWorker registration failed: "+n)})};this.requestPermission(u,r,s)}else if(this.pn){if(this.an==null||this.an==="")return t.error("You must supply the safariWebsitePushId initialization option in order to use registerPush on Safari"),void(typeof e=="function"&&e(!0));const s=window.safari.pushNotification.permission(this.an);this.An(this.an,s,i,e)}}unsubscribe(i,e){if(!y.isPushSupported())return t.info(v.Nn),void(typeof e=="function"&&e());this.ln?navigator.serviceWorker.getRegistration().then(s=>{s?s.pushManager.getSubscription().then(r=>{r?(this.Pn(),r.unsubscribe().then(o=>{o?(t.info("Device successfully unsubscribed from push."),typeof i=="function"&&i()):(t.error("Failed to unsubscribe device from push."),typeof e=="function"&&e()),this.xn(s)}).catch(o=>{t.error("Push unsubscription error: "+o),typeof e=="function"&&e()})):(t.info("Device already unsubscribed from push."),typeof i=="function"&&i())}).catch(r=>{t.error("Error unsubscribing from push: "+r),typeof e=="function"&&e()}):(t.info("Device already unsubscribed from push."),typeof i=="function"&&i())}):this.pn&&(this.Pn(),t.info("Device unsubscribed from push."),typeof i=="function"&&i())}}v.Nn="Push notifications are not supported in this browser.";const l={t:!1,i:null,m:()=>(l.o(),l.i||(l.i=new v(h.pr(),h.ba(),h.te(),h.Hs(),h.nn(w.wa),h.nn(w.ya),h.ir(),h.nn(w.Ma),h.nn(w._a),h.l())),l.i),o:()=>{l.t||(h.g(l),l.t=!0)},destroy:()=>{l.i=null,l.t=!1}};export{l as default};
//# sourceMappingURL=push-manager-factory-Cz2QYeAO.js.map
